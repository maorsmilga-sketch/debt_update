<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>× ×™×”×•×œ ×›×¡×¤×™× - ×××•×¨ ×•×¢×™×“×•</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    /* ×”-CSS ×”××§×•×¨×™ ×©×œ×š ×œ×œ× ×©×™× ×•×™ */
    :root {
      --primary-color: #059669; --primary-hover: #047857; --bg-color: #F3F4F6;
      --card-bg: #ffffff; --text-main: #1F2937; --text-secondary: #6B7280;
      --border-color: #E5E7EB; --success-color: #10B981; --error-color: #EF4444;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    body { font-family: 'Rubik', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
    .container { background: var(--card-bg); width: 100%; max-width: 450px; border-radius: 24px; box-shadow: var(--shadow); padding: 30px; position: relative; overflow: hidden; }
    .corner-logo { position: absolute; top: 20px; width: 50px; opacity: 0.9; }
    .logo-right { right: 20px; } .logo-left { left: 20px; }
    h1 { text-align: center; font-size: 1.5rem; font-weight: 700; margin-top: 10px; margin-bottom: 25px; }
    
    /* ×ª×•×¡×¤×ª: ×›×¤×ª×•×¨ ×™×¦×•× ×¨××©×™ */
    .export-main-btn { width: 100%; background: #4B5563; color: white; border: none; padding: 10px; border-radius: 12px; margin-bottom: 20px; cursor: pointer; font-family: inherit; font-weight: 500; transition: 0.2s; }
    .export-main-btn:hover { background: #374151; }

    .totals-container { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
    .total-card { flex: 1; text-align: center; background: #F9FAFB; padding: 15px 10px; border-radius: 16px; border: 1px solid var(--border-color); position: relative; }
    .total-label { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px; }
    .total-value { font-size: 1.2rem; font-weight: 700; color: var(--primary-color); min-height: 24px; margin-bottom: 8px; }
    
    /* ×ª×•×¡×¤×ª: ×›×¤×ª×•×¨ ×¤×™×¨×•×˜ ×™×•××™ ×§×˜×Ÿ */
    .detail-btn { background: #E5E7EB; border: none; padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; cursor: pointer; color: var(--text-main); }
    .detail-btn:hover { background: #D1D5DB; }

    /* Modals CSS */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal-content { background: white; width: 90%; max-width: 360px; border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .modal-header { font-weight: 700; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; text-align: center; }
    .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #eee; font-size: 0.9rem; }
    .total-line { font-weight: 700; color: var(--primary-color); margin-top: 15px; text-align: center; }
    .close-modal { width: 100%; margin-top: 20px; padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-family: inherit; }

    /* ×¢×™×¦×•×‘ ×”×˜×¤×¡×™× ×”××§×•×¨×™ ×©×œ×š */
    .section-title { font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 10px; display: block; }
    .user-selector { display: flex; gap: 10px; margin-bottom: 25px; }
    .user-option { flex: 1; position: relative; }
    .user-option input { position: absolute; opacity: 0; width: 0; }
    .user-card { display: flex; align-items: center; justify-content: center; padding: 12px; border: 2px solid var(--border-color); border-radius: 12px; cursor: pointer; font-weight: 500; transition: 0.2s; }
    .user-option input:checked + .user-card { border-color: var(--primary-color); background-color: #ECFDF5; color: var(--primary-color); font-weight: 700; }
    .quick-amounts { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
    .amount-btn { background: #fff; border: 1px solid var(--border-color); padding: 12px 0; border-radius: 10px; cursor: pointer; transition: 0.2s; font-family: inherit; }
    .input-wrapper input { width: 100%; padding: 14px 15px; border: 1px solid var(--border-color); border-radius: 12px; font-size: 1rem; box-sizing: border-box; background: #F9FAFB; margin-bottom: 15px; font-family: inherit; }
    .submit-btn { width: 100%; padding: 16px; background: var(--primary-color); color: white; border: none; border-radius: 14px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 6px rgba(5, 150, 105, 0.3); font-family: inherit; }
    .submit-btn:disabled { background: #9CA3AF; }
    .status { margin-top: 15px; text-align: center; font-size: 0.9rem; min-height: 20px; }
    .skeleton { background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 4px; width: 70%; height: 20px; display: inline-block; }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s linear infinite; margin-right: 8px; }
  </style>
</head>
<body>

  <div class="container">
    <img src="logo1.png" alt="Logo" class="corner-logo logo-right">
    <img src="logo1.png" alt="Logo" class="corner-logo logo-left">
    
    <h1>× ×™×”×•×œ ×›×¡×¤×™×</h1>

    <button class="export-main-btn" onclick="openExportModal()">ğŸ“¥ ×™×™×¦×•× × ×ª×•× ×™× ×œ××§×¡×œ</button>

    <div class="totals-container">
      <div class="total-card" id="cardMaor">
        <div class="total-label">×××•×¨</div>
        <div class="total-value" id="totalMaor"><span class="skeleton"></span></div>
        <button class="detail-btn" onclick="showDailyDetails('×××•×¨')">×¤×™×¨×•×˜ ×™×•××™</button>
      </div>
      <div class="total-card" id="cardIdo">
        <div class="total-label">×¢×™×“×•</div>
        <div class="total-value" id="totalIdo"><span class="skeleton"></span></div>
        <button class="detail-btn" onclick="showDailyDetails('×¢×™×“×•')">×¤×™×¨×•×˜ ×™×•××™</button>
      </div>
    </div>

    <span class="section-title">×œ××™ ×œ×¢×“×›×Ÿ?</span>
    <div class="user-selector">
      <label class="user-option"><input type="radio" name="user" value="×××•×¨" checked><div class="user-card">×××•×¨</div></label>
      <label class="user-option"><input type="radio" name="user" value="×¢×™×“×•"><div class="user-card">×¢×™×“×•</div></label>
    </div>

    <span class="section-title">×‘×—×™×¨×” ××”×™×¨×”</span>
    <div class="quick-amounts">
      <button type="button" class="amount-btn" onclick="setAmt(50)">50</button>
      <button type="button" class="amount-btn" onclick="setAmt(100)">100</button>
      <button type="button" class="amount-btn" onclick="setAmt(150)">150</button>
      <button type="button" class="amount-btn" onclick="setAmt(200)">200</button>
    </div>

    <input type="number" id="manualAmount" placeholder="×¡×›×•× ××—×¨">
    <input type="text" id="note" placeholder="×”×¢×¨×” (××•×¤×¦×™×•× ×œ×™)">

    <button class="submit-btn" id="submitBtn" onclick="sendData()">×¢×“×›×Ÿ ×™×ª×¨×”</button>
    <div class="status" id="status"></div>
  </div>

  <div id="detailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header" id="modalTitle">×¤×™×¨×•×˜ ×¢×¡×§××•×ª</div>
      <div id="modalBody" style="max-height: 250px; overflow-y: auto;"></div>
      <div class="total-line" id="modalTotal"></div>
      <button class="close-modal" onclick="closeModal('detailModal')" style="background:#eee;">×¡×’×•×¨</button>
    </div>
  </div>

  <div id="exportModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">×”×’×“×¨×•×ª ×™×™×¦×•× ×œ××§×¡×œ</div>
      <div style="display:flex; flex-direction:column; gap:10px;">
        <label style="font-size:0.85rem;">×‘×—×¨ ×©×—×§×Ÿ:</label>
        <select id="exportUser" style="padding:10px; border-radius:8px; border:1px solid #ccc;">
          <option value="×©× ×™×”×">×©× ×™×”×</option>
          <option value="×××•×¨">×××•×¨</option>
          <option value="×¢×™×“×•">×¢×™×“×•</option>
        </select>
        <label style="font-size:0.85rem;">××—×•×“×©:</label>
        <input type="month" id="startMonth" style="padding:10px; border-radius:8px; border:1px solid #ccc;">
        <label style="font-size:0.85rem;">×¢×“ ×—×•×“×©:</label>
        <input type="month" id="endMonth" style="padding:10px; border-radius:8px; border:1px solid #ccc;">
      </div>
      <button class="close-modal" id="downloadBtn" onclick="runExport()" style="background:var(--primary-color); color:white;">×”×•×¨×“ ×§×•×‘×¥</button>
      <button class="close-modal" onclick="closeModal('exportModal')" style="background:#eee; margin-top:5px;">×‘×™×˜×•×œ</button>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyk7vecQ3v0SwrsG1DkSaMQg3owGcSvtRe72ScbaH2ErO8FOtllPuDtAy2bRaMZjpUd1g/exec';

    function setAmt(val) { document.getElementById('manualAmount').value = val; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function openExportModal() { document.getElementById('exportModal').style.display = 'flex'; }

    // ×˜×¢×™× ×ª ×™×ª×¨×•×ª ×¨××©×•× ×™×ª
    async function loadTotals() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        document.getElementById('totalMaor').innerText = (data.totals['×××•×¨'] || 0).toLocaleString() + ' â‚ª';
        document.getElementById('totalIdo').innerText = (data.totals['×¢×™×“×•'] || 0).toLocaleString() + ' â‚ª';
      } catch (e) { console.error(e); }
    }

    // ×¢×“×›×•×Ÿ ×™×ª×¨×”
    async function sendData() {
      const user = document.querySelector('input[name="user"]:checked').value;
      const amount = document.getElementById('manualAmount').value;
      const note = document.getElementById('note').value;
      const btn = document.getElementById('submitBtn');

      if (!amount) return alert("×™×© ×œ×”×–×™×Ÿ ×¡×›×•×");
      
      btn.disabled = true;
      btn.innerHTML = '××¢×“×›×Ÿ... <span class="spinner"></span>';

      try {
        await fetch(API_URL, {
          method: 'POST',
          mode: 'no-cors',
          body: JSON.stringify({ user, amount, note })
        });
        document.getElementById('manualAmount').value = '';
        document.getElementById('note').value = '';
        document.getElementById('status').innerText = '×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!';
        document.getElementById('status').className = 'status success';
        setTimeout(() => document.getElementById('status').innerText = '', 3000);
        await loadTotals();
      } catch (e) { alert("×©×’×™××” ×‘×¢×“×›×•×Ÿ"); }
      btn.disabled = false;
      btn.innerText = '×¢×“×›×Ÿ ×™×ª×¨×”';
    }

    // ×¤×™×¨×•×˜ ×™×•××™
    async function showDailyDetails(user) {
      const modal = document.getElementById('detailModal');
      const body = document.getElementById('modalBody');
      const title = document.getElementById('modalTitle');
      const totalDiv = document.getElementById('modalTotal');

      body.innerHTML = "×˜×•×¢×Ÿ × ×ª×•× ×™×...";
      modal.style.display = "flex";

      try {
        const res = await fetch(`${API_URL}?action=getDetails&user=${user}`);
        const data = await res.json();
        title.innerText = `×¤×™×¨×•×˜ ×™×•××™ - ${user}`;
        body.innerHTML = data.details.items.length > 0 
          ? data.details.items.map(i => `<div class="detail-row"><span>${i.note}</span><span style="font-weight:700;">${i.amount.toLocaleString()} â‚ª</span></div>`).join('')
          : "××™×Ÿ ×¢×¡×§××•×ª ×œ×”×™×•×";
        totalDiv.innerText = `×¡×”"×› ×œ×”×™×•×: ${data.details.total.toLocaleString()} â‚ª`;
      } catch (e) { body.innerHTML = "×©×’×™××” ×‘×˜×¢×™× ×”"; }
    }

    // ×™×™×¦×•× ×œ××§×¡×œ
    async function runExport() {
      const user = document.getElementById('exportUser').value;
      const start = document.getElementById('startMonth').value;
      const end = document.getElementById('endMonth').value;
      const btn = document.getElementById('downloadBtn');

      btn.innerText = "××¢×‘×“...";
      btn.disabled = true;

      try {
        const res = await fetch(`${API_URL}?action=export&user=${encodeURIComponent(user)}&startMonth=${start}&endMonth=${end}`);
        const json = await res.json();

        if (json.data && json.data.length > 0) {
          let csv = "\uFEFF×ª××¨×™×š,×©×,×¡×›×•×,×”×¢×¨×”\n" + json.data.map(r => `${r.date},${r.user},${r.amount},"${r.note}"`).join("\n");
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = `×“×•×—_${user}_${new Date().toLocaleDateString()}.csv`;
          link.click();
          closeModal('exportModal');
        } else { alert("×œ× × ××¦××• × ×ª×•× ×™×"); }
      } catch (e) { alert("×©×’×™××” ×‘×™×™×¦×•×"); }
      btn.innerText = "×”×•×¨×“ ×§×•×‘×¥";
      btn.disabled = false;
    }

    loadTotals();
  </script>
</body>
</html>
